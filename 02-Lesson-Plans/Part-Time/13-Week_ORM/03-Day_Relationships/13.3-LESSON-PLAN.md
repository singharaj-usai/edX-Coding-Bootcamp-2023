# 13.3 Weekday Lesson Plan: Relationships with Sequelize

## Overview 

Today's lesson focuses on how to relate data between SQL tables using Sequelize associations and how to model one-to-one, one-to-many, and many-to-many relationships. Students will also learn how to write SQL subqueries with Sequelize literals, incorporate ESLint in a project, and deploy their application to Heroku with a MySQL database. 

## Instructor Notes

* In this lesson, students will complete activities `21-Ins_One-to-One` through `28-Stu_Mini-Project`.

* See the [Sequelize documentation on associations](https://sequelize.org/master/manual/assocs.html) to review how to create relationships. The documentation provides limited real-world examples, so be sure to look at how associations are implemented in the activities and mini-project before class.

* Instead of relying on a front end, all of the activities will use Insomnia to test the routes. Be sure to have it installed and set up for class. 

* To speed up demonstrations and activity reviews, you might want to run `npm install` and create the database for every activity before class starts. 

* Don't forget to run `node seeds/seed.js` before each demo or activity review, to seed the database. Remind students of the seed file too.

* All activities will require changing the `.env.EXAMPLE` file to `.env` and filling it with your MySQL credentials. Instruct students who arrive early to fill out that information ahead of time so that they can focus on the task at hand.

* `npx` is used in the `Everyone Do: ESLint` activity, but it is not a learning objective. If students get hung up on `npx`, briefly explain what it is but do not linger on it.  

* Remind students to do a `git pull` of the class repo to have today's activities ready and open in VS Code. 

* If you are comfortable doing so, live-code the solutions to the activities. If not, just use the solutions provided and follow the prompts and talking points for review. 

* Let students know that the Bonus at the end of each activity is not meant to be extra coding practice, but instead is a self-study on topics beyond the scope of this module for those who want to further their knowledge. 

* If the students struggle with the `Everyone Do: ESLint` activity, walk through it with the students using the talking points provided. Otherwise, support the students as they do the activity and do a brief review at the end. 

## Learning Objectives

By the end of class, students will be able to:

* Implement various Sequelize associations to create one-to-one, one-to-many, and many-to-many data relationships.

* Perform subqueries using a combination of Sequelize methods and plain SQL syntax.

* Enforce code styling for an application using ESLint.

* Deploy an application with a MySQL database to Heroku.

## Time Tracker

| Start | #   | Activity Name                       | Duration |
| ----- | --- | ----------------------------------- | -------- |
| 0:00  | 1   | Instructor Do: Stoke Curiosity      | 0:05     |
| 0:05  | 2   | Instructor Demo: One-to-One         | 0:05     |
| 0:10  | 3   | Student Do: One-to-One              | 0:15     |
| 0:25  | 4   | Instructor Review: One-to-One       | 0:10     |
| 0:35  | 5   | Instructor Demo: One-to-Many        | 0:05     |
| 0:40  | 6   | Student Do: One-to-Many             | 0:15     |
| 0:55  | 7   | Instructor Review: One-to-Many      | 0:10     |
| 1:05  | 8   | Instructor Demo: Literals           | 0:05     |
| 1:10  | 9   | Student Do: Literals                | 0:15     |
| 1:25  | 10  | BREAK                               | 0:10     |
| 1:35  | 11  | Instructor Review: Literals         | 0:10     |
| 1:45  | 12  | Everyone Do: ESLint                 | 0:10     |
| 1:55  | 13  | Instructor Demo: Mini-Project       | 0:05     |
| 2:00  | 14  | Student Do: Mini-Project            | 0:45     |
| 2:45  | 15  | Instructor Review: Mini-Project     | 0:10     |
| 2:55  | 16  | Introduce Challenge                 | 0:05     |
| 3:00  | 17  | END                                 | 0:00     |

---

## Class Instruction

### 1. Instructor Do: Stoke Curiosity (5 min)

* Welcome students to class.

* Remind students that one of the main offerings of SQL is the ability to connect multiple tables of data to each other to create relationships between them. 

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What are some examples of data that we could relate using SQL? 

  * üôã Artists and albums or songs, pet owners and their pets, and more! Almost any relationship that exists in real life can be represented in a SQL database.

  * ‚òùÔ∏è Why would we want to represent these real-world relationships in an application?

  * üôã Web applications like social networks and online stores that remember customers' personal preferences are all digital representations of characteristics and relationships that exist in real life. These kinds of apps can help users more easily connect with each other, shop online, and accomplish other daily tasks.

  * ‚òùÔ∏è Using plain SQL, how do we establish these relationships?

  * üôã We define a relationship between tables by creating a foreign key column that holds a reference to the primary key of the related data.

  * ‚òùÔ∏è Can we build the same type of relationships using Sequelize?

  * üôã You bet! 

* Explain that today we will focus on how Sequelize allows us to more clearly define relationships between data. Students will also learn some other interesting tools to become better developers.

* Answer any questions before proceeding to the next activity.

### 2. Instructor Demo: One-to-One (5 min)

* Navigate to `21-Ins_One-to-One` and run `npm install` from the command line. Be sure to change the `.env.EXAMPLE` file into your own `.env` file with your credentials. Then run `npm start` from the command line and demonstrate the following:

  * üîë By default, Sequelize logs the commands that it performs on the SQL server, even on load. You can see that in the following example:

    ```bash
    Executing (default): CREATE TABLE IF NOT EXISTS `driver` (`id` INTEGER NOT NULL auto_increment , `name` VARCHAR(255) NOT NULL, `address` VARCHAR(255) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB;
    Executing (default): SHOW INDEX FROM `driver`
    Executing (default): CREATE TABLE IF NOT EXISTS `license` (`id` INTEGER NOT NULL auto_increment , `license_number` CHAR(36) BINARY, `is_donor` TINYINT(1) DEFAULT true, `driver_id` INTEGER, PRIMARY KEY (`id`), FOREIGN KEY (`driver_id`) REFERENCES `driver` (`id`) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE=InnoDB;
    Executing (default): SHOW INDEX FROM `license`
    ```

  * üîë In these statements that create the tables, the `license` table stores a reference to the `driver` table as a foreign key.

* Ask the class the following question (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Why would we want license data to have a reference to a driver?

  * üôã A driver's license belongs to a specific driver, so we need to know which driver holds this license.

* Open `21-Ins_One-to-One/models/Driver.js` in your IDE and explain the following:

  * üîë In the `Driver` model, nothing indicates ownership of a license.

* Open `21-Ins_One-to-One/models/License.js` in your IDE and explain the following:

  * üîë However, a column in the `License` model specifically references the `Driver` model, as follows:

    ```js
    // This column will store a reference of the `id` of the `Driver` that owns this License
    driver_id: {
      type: DataTypes.INTEGER,
      references: {
        // This references the `driver` model, which we set in `Driver.js` as its `modelName` property
        model: 'driver',
        key: 'id',
      },
    },
    ```

* Open `21-Ins_One-to-One/models/index.js` in your IDE and explain the following:

  * üîë We import both models and instruct Sequelize to create a relationship between them, like in the following example:

    ```js
    // Define a Driver as having one License to create a foreign key in the `license` table
    Driver.hasOne(License, {
      foreignKey: 'driver_id',
      // When we delete a Driver, make sure to also delete the associated License.
      onDelete: 'CASCADE',
    });

    // We can also define the association starting with License
    License.belongsTo(Driver, {
      foreignKey: 'driver_id',
    });
    ```

  * We need to import the models into `index.js` before establishing any associations between them.

* Ask the class the following question (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What do we think the `hasOne()` method does here?

  * üôã A driver should only have one driver's license, so the `hasOne()` method probably enforces that!

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `22-Stu_One-to-One/README.md`.

### 3. Student Do: One-to-One (15 min)

* Direct students to the activity instructions found in `22-Stu_One-to-One/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # üìê Add Comments to Implementation of a One-to-One Association

  Work with a partner to add comments describing the functionality of the code found in the following files: 

  * [Unsolved/models/index.js](./Unsolved/models/index.js)

  * [Unsolved/models/LibraryCard.js](./Unsolved/models/LibraryCard.js)

  * [Unsolved/routes/api/readerRoutes.js](./Unsolved/routes/api/readerRoutes.js)

  * [Unsolved/routes/api/libraryCardRoutes.js](./Unsolved/routes/api/libraryCardRoutes.js)

  ## üìù Notes

  Refer to the documentation: 

  [Sequelize documentation on associations](https://sequelize.org/master/manual/assocs.html)

  ---

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * What is an entity-relationship diagram (ERD)?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help.

### 4. Instructor Review: One-to-One (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with one-to-one relationships in Sequelize? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è `hasOne()`
  
  * ‚úîÔ∏è Foreign key columns

   * ‚úîÔ∏è `belongsTo`

  * ‚úîÔ∏è Performing JOIN with `include` option

* Open `22-Stu_One-to-One/Solved/models/LibraryCard.js` in your IDE and explain the following:

  * üîë We create a foreign key column to reference the library card's `Reader`, as shown in the following example:

    ```js
    reader_id: {
      type: DataTypes.INTEGER,
      references: {
        model: 'reader',
        key: 'id',
      },
    },
    ```

* Open `22-Stu_One-to-One/Solved/models/index.js` in your IDE and explain the following:

  * üîë We import both models, associate them to one another, and export them as an object, like in the following example:

    ```js
    const Reader = require('./Reader');
    const LibraryCard = require('./LibraryCard');
    ```

    * üîë To associate the `Reader` model with the `LibraryCard` model in a one-to-one relationship, we use the `hasOne()` method to declare a model has one of another model, or in this case, the `Reader` has one `LibraryCard`. The foreign key will be defined on the `Reader` model. 

    ```js
    Reader.hasOne(LibraryCard, {
      foreignKey: 'reader_id',
      onDelete: 'CASCADE',
    });
    ```

    * üîë We then use the `belongsTo()` method to define the relationship between two models. It is important that both `hasOne()` and `belongsTo` are both used. They are a pair!

    ```js
    LibraryCard.belongsTo(Reader, {
      foreignKey: 'reader_id',
    });

    module.exports = { Reader, LibraryCard };
    ```

* Open `22-Stu_One-to-One/Solved/routes/api/readerRoutes.js` in your IDE and explain the following:

  * In the API route files, we import both models through destructuring, as follows:

    ```js
    const { LibraryCard, Reader } = require('../../models');
    ```

  * üîë Also in the API route files, the GET routes use the `include` option to perform a SQL JOIN, as shown in the following example:

    ```js
    const readerData = await Reader.findAll({
      include: [{ model: LibraryCard }],
    });
    ```

* If time allows, seed the database, run the app, and use Insomnia to demonstrate the following:

  * We can now create a library card and associate it with a reader by running a POST request to `/api/cards` with the following JSON body:

    ```json
    {
      "reader_id": 1
    }
    ```

  * We can also query a reader and get their associated library card by running a GET request to `/api/readers`.  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What two methods do we use to create a one-to-one relationship using Sequelize?  

  * üôã  In Sequelize, to form an association we use the `hasOne()` method to establish that a model has one of another model. Then, we use the `belongsTo()` method to define the relationship between the two models. It is important to use both of the association methods together to successfully define a one-to-one relationship. 

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [Sequelize documentation on one-to-one relationships](https://sequelize.org/master/manual/assocs.html#one-to-one-relationships), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 5. Instructor Demo: One-to-Many (5 min)

* Navigate to `23-Ins_One-to-Many` and run `npm install` from the command line. Be sure to change the `.env.EXAMPLE` file into your own `.env` file with your credentials. To speed things up, run `node seeds/seed.js` as well to seed the database tables.

* Run `npm start` from the command line and use Insomnia to demonstrate the following:

  * üîë When we perform a GET request to `/api/drivers/1`, we get a response like the following example&mdash;including not only the driver's license data but also an array of their owned cars:

    ```json
    {
      "id": 1,
      "name": "Sal",
      "address": "200 Response St",
      "license": {
        "id": 1,
        "license_number": "bea06fda-0543-4cc7-82e9-3743fccf566b",
        "is_donor": true,
        "driver_id": 1
      },
      "cars": [
        {
          "id": 2,
          "make": "Honda",
          "model": "Accord",
          "mileage": 30000,
          "driver_id": 1
        },
        {
          "id": 4,
          "make": "Toyota",
          "model": "Camry",
          "mileage": 60000,
          "driver_id": 1
        },
        {
          "id": 6,
          "make": "Subaru",
          "model": "Outback",
          "mileage": 20000,
          "driver_id": 1
        }
      ]
    }
    ```

* Open `23-Ins_One-to-Many` in your IDE and demonstrate the following:

  * üîë In `models/Car.js`, we create a model with a column to reference the `id` of the driver who owns it, as shown in the following example:

    ```js
    driver_id: {
      type: DataTypes.INTEGER,
      references: {
        model: 'driver',
        key: 'id',
      },
    },
    ```

  * üîë In `models/index.js`, drivers have one license. But now they also have many cars, and cars belong to one driver, as you can see in the following example:

    ```js
    Driver.hasMany(Car, {
      foreignKey: 'driver_id',
      onDelete: 'CASCADE',
    });

    Car.belongsTo(Driver, {
      foreignKey: 'driver_id',
    });
    ```

  * üîë In `routes/api/driverRoutes.js`, the GET route queries use the `include` option to perform a JOIN to retrieve the associated driver's license and cars, as follows:

    ```js
    const driverData = await Driver.findByPk(req.params.id, {
      include: [{ model: License }, { model: Car }],
    });
    ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Can we create a new driver's license or car without a driver?

  * üôã Nope! Both belong to specific drivers, so the driver has to exist in the database before the license or car can be created.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `24-Stu_One-to-Many/README.md`.

### 6. Student Do: One-to-Many (15 min)

* Direct students to the activity instructions found in `24-Stu_One-to-Many/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # üèóÔ∏è Implement One-to-Many Association Between Reader and Book Models

  Work with a partner to implement the following user story:

  * As a book owner, I want to see the books in my collection.

  ## Acceptance Criteria

  * It's done when the MySQL table for book data has a foreign key referencing the reader table.

  * It's done when the response of a GET request to `/api/readers` or `/api/readers/:id` includes the books owned by a reader, like the following JSON:

      ```json
      {
        "id": 1,
        "name": "Lernantino",
        "email": "lernantino@gmail.com",
        "password": "$2b$10$AcbPGE6mNk3aZAnFCan1XeVVbuDYhQiHxOQ/gIG/PSUj2WoOR2pGC",
        "library_card": {
          "id": 2,
          "card_number": "8342e78a-7265-4060-9834-81a19c76c041",
          "reader_id": 1
        },
        "books": [
          {
            "id": 4,
            "title": "The Pragmatic Programmer: Your Journey To Mastery",
            "author": "David Thomas",
            "isbn": "978-0135957059",
            "pages": 352,
            "edition": 2,
            "is_paperback": false,
            "reader_id": 1
          },
          {
            "id": 6,
            "title": "Algorithms of Oppression: How Search Engines Reinforce Racism",
            "author": "Safiya Umoja Noble",
            "isbn": "978-1479837243",
            "pages": 256,
            "edition": 1,
            "is_paperback": true,
            "reader_id": 1
          }
        ]
      }
      ```

  ---

  ## üí° Hints

  When you associate these models, what will the relationship look like? Would users belong to books, or would books belong to users? 

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * As a JavaScript developer using Sequelize, why do you still need to know SQL?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help.

### 7. Instructor Review: One-to-Many (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with one-to-many relationships? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è Foreign key column

  * ‚úîÔ∏è `hasMany()`

  * ‚úîÔ∏è `belongsTo()`

  * ‚úîÔ∏è `include`

* Open `24-Stu_One-to-Many/Solved/models/Book.js` in your IDE and explain the following:

  * üîë We add a column, as follows, to store a reference to the reader that owns the book:

    ```js
    reader_id: {
      type: DataTypes.INTEGER,
      references: {
        model: 'reader',
        key: 'id',
      },
    },
    ```

* Open `24-Stu_One-to-Many/Solved/models/index.js` in your IDE and explain the following:

  * üîë We create the relationship between readers and books by using the `hasMany()` relationship to declare readers have many books, as shown in the following example:

    ```js
    Reader.hasMany(Book, {
      foreignKey: 'reader_id',
      onDelete: 'CASCADE',
    });
    ```

  * üîë We pair the `hasMany()` association method with a `belongsTo()` declaration to show that while each reader has many books, a book belongs to a single reader. This forms the one-to-many relationship:
    
    ```js
    Book.belongsTo(Reader, {
      foreignKey: 'reader_id',
    });
    ```

* Open `24-Stu_One-to-Many/Solved/routes/api/readerRoutes.js` in your IDE and explain the following:

  * üîë We use the `findAll()` to find to return all of our data and an an `include` statement to identify the models we want to join:

    ```js
    const readerData = await Reader.findAll({
      include: [{ model: LibraryCard }, { model: Book }],
    });
    ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What happens to the books or library cards owned by a reader if that reader is deleted?

  * üôã They will also be deleted, because we set `onDelete: 'CASCADE'`.

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [Sequelize documentation on one-to-many relationships](https://sequelize.org/master/manual/assocs.html#one-to-many-relationships), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 8. Instructor Demo: Sequelize Literals (5 min) 

* Navigate to `25-Ins_Literals` and run `npm install` from the command line. Be sure to change the `.env.EXAMPLE` file into your own `.env` file with your credentials. To speed things up, run `node seeds/seed.js` as well to seed the database tables.

* Run `npm start` from the command line and use Insomnia to demonstrate the following: 

  * üîë When we perform a GET request to `/api/drivers/2`, we get a response that resembles the following example&mdash;including everything from before but also the total mileage of all cars owned by the driver:

    ```json
    {
      "id": 2,
      "name": "Lernantino",
      "address": "404 Express Blvd",
      "totalMileage": "150000",
      "license": {
        "id": 2,
        "license_number": "54f17c3c-aef2-49ac-b68a-b66f8645222d",
        "is_donor": true,
        "driver_id": 2
      },
      "cars": [
        {
          "id": 1,
          "make": "Ford",
          "model": "Mustang",
          "mileage": 40000,
          "driver_id": 2
        },
        {
          "id": 4,
          "make": "Toyota",
          "model": "Camry",
          "mileage": 60000,
          "driver_id": 2
        },
        {
          "id": 5,
          "make": "Toyota",
          "model": "Corolla",
          "mileage": 50000,
          "driver_id": 2
        }
      ]
    }
    ```

* Open `25-Ins_Literals/routes/api/driverRoutes.js` in your IDE and demonstrate the following:

  * üîë We update the query to include a new attribute called `totalMileage` that has a value of the output of a SQL function, as follows:

    ```js
    const driverData = await Driver.findAll({
      include: [{ model: License }, { model: Car }],
      attributes: {
        include: [
          [
            // Use plain SQL to add up the total mileage
            sequelize.literal(
              '(SELECT SUM(mileage) FROM car WHERE car.driver_id = driver.id)'
            ),
            'totalMileage',
          ],
        ],
      },
    });
    ```

  * üîë Because we need to perform a SQL query on the database connection, we import the Sequelize instance at the top of the file, as shown in the following example:

    ```js
    const sequelize = require('../../config/connection');
    ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Why would we want to use regular SQL with Sequelize?

  * üôã Sequelize provides a lot of built-in functionality, but it can be easier to write a more complex query using regular SQL syntax instead. 

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `26-Stu_Literals/README.md`.

### 9. Student Do: Sequelize Literals (15 min) 

* Direct students to the activity instructions found in `26-Stu_Literals/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # üêõ Users Route Is Missing Data

  Work with a partner to resolve the following issues:

  * As a user, I want to see the books I own and a count of how many of those are short novels.

  ## Expected Behavior

  When a request is made for user data, the response includes a `shortBooks` property that counts the books with between 100 and 300 pages.

  ## Actual Behavior

  The user data in the response does not include a `shortBooks` property.

  ## Steps to Reproduce the Problem

  1. Run `node seeds.js` from the command line to seed the database.

  2. Run `npm start` to start the server.

  3. In Insomnia, make a GET request to `/api/readers/1`.

  4. Note that the response data does not include a `shortBooks` property.

  ---

  ## üí° Hints

  How could you obtain this short novel count using a regular SQL query?

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How would you build a many-to-many relationship using Sequelize?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help.

### 10. BREAK (10 min)

### 11. Instructor Review: Sequelize Literals (10 min) 

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel using regular SQL queries in Sequelize? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è `attribute` 

  * ‚úîÔ∏è `sequel.literal()` 

  * ‚úîÔ∏è `COUNT()` 

* Open `26-Stu_Literals/Solved/routes/api/readerRoutes.js` in your IDE and explain the following: 

  * üîë For the GET routes, we add the `attributes` option to instruct Sequelize to include or exclude any columns or fields, as follows:

    ```js
    const readerData = await Reader.findAll({
      include: [{ model: LibraryCard }, { model: Book }],
      attributes: {
        include: [
          [
            // Use plain SQL to get a count of all short books
            sequelize.literal(
              '(SELECT COUNT(*) FROM book WHERE pages BETWEEN 100 AND 300 AND book.reader_id = reader.id)'
            ),
            'shortBooks',
          ],
        ],
      },
    });
    ```

  * üîë In the `include` option, we add an array with the `sequelize.literal()` query first and the attribute name we'll use second. 

  * üîë The SQL `COUNT()` function will return the number of books with between 100 and 300 pages.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How can we make this code easier to read in the route's callback function?

  * üôã We can create a static Sequelize method to perform on the model.

  * ‚òùÔ∏è Why does the SQL query have to explicitly include `book.reader_id = reader.id`?

  * üôã Without that part of the query, it would count ALL books and not just the books owned by this reader.

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [Sequelize documentation on subqueries](https://sequelize.org/master/manual/sub-queries.html), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `27-Evr_Eslint/README.md`.

### 12. Everyone Do: ESLint (10 min)

* Open the [ESLint documentation](https://eslint.org/) in your browser and explain the following:

  * We can use **ESLint** to help enforce code styling and consistency in web applications.

* Direct students to the activity instructions found in `27-Evr_Eslint/README.md`:

  ```md
  # üêõ Code Not Following ESLint Rules

  Work with a partner to resolve the following issues:

  * As a developer on a team, I want my team's codebase to follow uniform formatting and styling, using ESLint rules.

  ## Expected Behavior

  The code in [Unsolved/example.js](Unsolved/example.js) should pass all tests and rules listed in [Unsolved/.eslintrc.json](Unsolved/.eslintrc.json), and it should not have red underlines.

  ## Actual Behavior

  The code in [Unsolved/example.js](Unsolved/example.js) does not pass most rules listed in [Unsolved/.eslintrc.json](Unsolved/.eslintrc.json), and it does have red underlines.

  ## Steps to Reproduce the Problem

  1. Install the [VS Code EsLint Extension](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint).

  2. From the command line, run `npm install` in the [Unsolved](./Unsolved) folder.

  3. Open [Unsolved/example.js](Unsolved/example.js) in your code editor. If you completed the previous steps correctly, you should see red annotations under different parts of the code. Hovering over each one displays a popover that lists an ESLint rule being broken.

      * Alternatively, you can run `npm run test` to get a list of code styling errors and where they occur.

  ---

  ## üí° Hints

  How can we better understand the rules in [Unsolved/.eslintrc.json](Unsolved/.eslintrc.json) using the [ESLint documentation on rules](https://eslint.org/docs/rules/)?

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How can we ensure that the code passes all ESLint checks before merging a GitHub pull request? 

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While everyone is working on the activity, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help.

* Navigate to `27-Evr_Eslint/Unsolved` on the command line, run `npm install`, and demonstrate the following:

  * üîë If we run `npm run test`, ESLint will check all of the JavaScript files for code styling issues by comparing it to both its internal base rules and the rules that are present in `.eslintrc.json`.

* Open `27-Evr_EsLint/Unsolved` in your IDE to demonstrate the following:

  * üîë The ESLint extension for VS Code also allows us to open a file like `example.js` and view what's wrong. We can highlight underlined code to get a dialog that explains what's wrong and how we can fix it.

  * In the `.eslintrc.json` file, we can tell ESLint how to handle certain rules and formats.

  * In `package.json`, we use the `npm run test` script to run the `npm run lint` script. 

  * The `npm run lint` script uses `npx` to temporarily download ESLint as an executable command and run it on all files that match the extension of `.js`. We use `exit 0` at the end, like in the following example, to prevent Node.js from throwing an error when the linting doesn't pass:

    ```json
    "lint": "npx eslint **/*.js --quiet; exit 0",
    ``` 

* Answer any questions before proceeding to the next activity.

### 13. Instructor Demo: Mini-Project (5 min) 

* Navigate to `28-Stu_Mini-Project/Main` and run `npm install` from the command line. Be sure to change the `.env.EXAMPLE` file into your own `.env` file with your credentials. To speed things up, run `node seeds/seed.js` as well to seed the database tables.

* Run `npm start` from the command line and use Insomnia to demonstrate the following: 

  * üîë When we perform a GET request to `/api/travellers/:id` (pick an `id`), we receive data for a traveller, along with the locations they plan on visiting and more information for that trip, as shown in the following example:

    ```json
    {
      "id": 2,
      "name": "Lernantino",
      "email": "lernantino@gmail.com",
      "trip_locations": [
        {
          "id": 4,
          "location_name": "Miami",
          "trip": {
            "id": 4,
            "trip_date": null,
            "traveller_amount": 3,
            "traveller_id": 2,
            "location_id": 4
          }
        }
      ]
    }
    ```

  * üîë When we perform a GET request to `/api/locations/:id` (again, pick an `id`), we receive data about a location and which travellers have planned trips there.

  * üîë This data is spread across three tables, where travellers can visit many locations and locations can have many travellers&mdash;through trips. A trip can only be created if a traveller and a location already exist.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Would this be considered a one-to-one association, a one-to-many association, or a different type of relationship?

  * üôã It's a type of relationship known as **many-to-many**, where data in either table is not necessarily owned by an entity but rather shared. For example, think of a blog. Blog posts can have multiple tags, and any given tag can be applied to many blog posts.

* Answer any questions before allowing students to start the mini-project.

### 14. Student Do: Mini-Project (45 min)

* Direct students to the activity instructions found in `28-Stu_Mini-Project`.

* Break your students into groups that will work together on this activity.

  ```md
  # Module 13 Mini-Project: Travel Planner

  In this mini-project, you will work with a group to build an API using Node.js, Express.js, MySQL, and Sequelize, and you will deploy it to Heroku.

  ## User Stories

  * As a traveller, I want to be able to create an account.

  * As a traveller, I want to be able to create a new trip for myself using a location from a list.

  * As a traveller, I want to be able to create and view location data.

  * As a traveller, I want to be able to view all of the trips I'm taking, along with their locations.

  ## Acceptance Criteria

  * It's done when the GET route `/api/travellers` returns all traveller data without associated trips in Insomnia.

  * It's done when the POST route `/api/travellers` creates traveller data and returns a successful response in Insomnia.

  * It's done when the GET route `/api/travellers/:id` returns a single traveller's data with their associated trips and a list of locations in Insomnia. 

  * It's done when the DELETE route `/api/travellers/:id` removes a traveller and any trips associated with them and returns a successful response in Insomnia.

  * It's done when the GET route `/api/locations` returns all location data in Insomnia.

  * It's done when the POST route `/api/locations` creates location data and returns a successful response in Insomnia.

  * It's done when the GET route `/api/locations/:id` returns a single location's data, with its associated trips, in Insomnia. 

  * It's done when the DELETE route `/api/locations/:id` removes a location and any trips associated with it and returns a successful response in Insomnia.

  * It's done when the POST route `/api/trips` creates trip data between associated travellers and locations.

  * It's done when the DELETE route `/api/trips/:id` removes a trip and returns a successful response in Insomnia.

  * It's done when the API is successfully deployed to Heroku with a MySQL database.

  ## Specifications 

  * Database models should have the following fields and associations:

    * `Traveller`

      * `id`: primary key

      * `name`
        
      * `email`

    * `Location`

      * `id`: primary key
      
      * `name`

    * `Trips`
        
      * `id`: primary key

      * `trip_budget` 
        
      * `traveller_amount`
        
      * `traveller_id`: non-unique foreign key that references the `Traveller` model's `id` field (`Traveller.id`)

      * `location_id`: non-unique foreign key that references the `Location` model's `id` field (`Location.id`)

    * Travellers have many locations, and locations have many travellers through trips (many-to-many association).

    * Set the `unique` flag to `false` to avoid a SQL error when creating the many-to-many relationship, because travellers can take multiple trips.

  ## üìù Notes

  Refer to the documentation: 

  * [Sequelize documentation on many-to-many relationships](https://sequelize.org/master/manual/assocs.html#many-to-many-relationships)

  * [The Full-Stack Blog guide to deploying with Heroku and MySQL](https://coding-boot-camp.github.io/full-stack/heroku/deploy-with-heroku-and-mysql)

  Use the following sample data as the request body POST `/api/trips` route:

    ```json
    {
      "trip_budget": 2000.50,
      "traveller_amount": 6,
      "traveller_id": 1,
      "location_id": 2
    }
    ```

  ---

  ## üí° Hints

  * What model association option can we set to automatically delete associated data? 

  * How can we use the data in `Develop/seeds` to provide starter data for locations and travellers and not have to create it ourselves? 

  * If we're deploying this to Heroku, can we work on this from within the class repository, or should we make a new GitHub repo?

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * Add validations to all of the model data.

  * Create a password hashing and login system for travellers.

  * Set up a **super many-to-many relationship** between travellers, locations, and trips to provide more querying options. To learn more, see the [Sequelize documentation on advanced many-to-many relationships](https://sequelize.org/master/manual/advanced-many-to-many.html).
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help.

### 15. Instructor Review: Mini-Project (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with this mini-project? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (üîë) points:

  * ‚úîÔ∏è Two foreign keys in through table `Trip`

  * ‚úîÔ∏è `.belongsToMany()` and `through` option

  * ‚úîÔ∏è `include` with a through table

  * ‚úîÔ∏è JawsDB environment variable for production

* Open `28-Stu_Mini-Project/Solved/models/Trip.js` in your IDE and explain the following: 

  * üîë We want a `Trip` model to be the joining table (or **through table**, in Sequelize terms) between locations and travellers, so we create foreign key columns for both. See the following code for an example:

    ```js
    traveller_id: {
      type: DataTypes.INTEGER,
      references: {
        model: 'traveller',
        key: 'id'
      }
    },
    location_id: {
      type: DataTypes.INTEGER,
      references: {
        model: 'location',
        key: 'id'
      }
    }
    ```

* Open `28-Stu_Mini-Project/Solved/models/index.js` in your IDE and explain the following: 

  * üîë We associate locations and travellers to one another through trips, as follows:

    ```js
    Traveller.belongsToMany(Location, {
      through: Trip,
      // Define an alias for when data is retrieved
      as: 'planned_trips',
      foreignKey: 'traveller_id'
    });

    Location.belongsToMany(Traveller, {
      through: Trip,
      // Define an alias for when data is retrieved
      as: 'location_travellers',
      foreignKey: 'location_id'
    });
    ``` 

* Open `28-Stu_Mini-Project/Solved/routes/api/travellerRoutes.js` in your IDE and explain the following: 

  * üîë In the GET routes, we use `include` with the `through` option, to perform a many-to-many JOIN like in the following example:

    ```js
    // From`travellerRoutes.js`
    const travellerData = await Traveller.findByPk(req.params.id, {
      // JOIN with locations, using the Trip through table
      include: [{ model: Location, through: Trip, as: 'planned_trips' }]
    });
    ```

  * We do not use the `include` option in the routes that retrieve all data, because typically we would not need that data until we are viewing a single item's detailed data.

* Open `28-Stu_Mini-Project/Solved/config/connection.js` in your IDE and explain the following: 

  * üîë We use `process.env.JAWSDB_URL` as a placeholder value that will be used in production by Heroku, as follows:

    ```js
    if (process.env.JAWSDB_URL) {
      sequelize = new Sequelize(process.env.JAWSDB_URL);
    } else {
      sequelize = new Sequelize(
        process.env.DB_NAME,
        process.env.DB_USER,
        process.env.DB_PASSWORD,
        {
          host: 'localhost',
          dialect: 'mysql',
          port: 3306
        }
      );
    }
    ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è With this many-to-many relationship, can multiple travellers create a trip to the same location?

  * üôã Yes! The idea of many-to-many relationships is that multiple connections can exist in a single set of data. The through table helps to store those pairings and prevent any duplicate data from being formed.

  * ‚òùÔ∏è Can we use the local machine's MySQL database instead of the one through Heroku?

  * üôã Yes, we can&mdash;but that would require us to leave the machine on all the time, so it is not a good idea.

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [Sequelize documentation on many-to-many relationships](https://sequelize.org/master/manual/assocs.html#many-to-many-relationships), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 16. Instructor Demo: Introduce Challenge (5 min)

* Navigate to `02-Challenge/Main` and run `npm install` from the command line. Be sure to change the `.env.EXAMPLE` file into your own `.env` file with your credentials. To speed things up, run `node seeds/seed.js` as well to seed the database tables.

* Run `npm start` from the command line and use Insomnia to demonstrate the following: 

  * We will build an e-commerce application back end that works with products, categories, and tags.

  * When we perform a GET request to `/api/products`, we get all products and their associated categories and tags.

* Open `02-Challenge/Develop` in your IDE and explain the following:

  * The structure for this application is already in place; we just need to create the models and finish the routes.

  * Students can use the comments in the files to help provide context as to what's needed. 

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What are we learning?

  * üôã How to structure and use a basic e-commerce database.

  * ‚òùÔ∏è How does this project build off or extend previously learned material?

  * üôã With the help of Sequelize, we will build one-to-many and many-to-many relationships and perform CRUD actions on the database using RESTful API endpoints.

  * ‚òùÔ∏è How does this project relate to your career goals?

  * üôã Establishing data relationships is a common&mdash;and crucial&mdash;aspect of back-end web development. If any part of your future career involves working on the back end of a database, you will need to be comfortable using technologies like these to create data associations.

* Ask TAs to direct students to the Challenge Requirements found in `02-Challenge/README.md`.

* Answer any questions before ending the class.

### 17. END (0 min)

How did today‚Äôs lesson go? Your feedback is important. Please take 5 minutes to complete this [anonymous survey](https://forms.gle/RfcVyXiMmZQut6aJ6).

---
¬© 2022 edX Boot Camps LLC. Confidential and Proprietary. All Rights Reserved.